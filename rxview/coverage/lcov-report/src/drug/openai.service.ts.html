
<!doctype html>
<html lang="en">

<head>
    <title>Code coverage report for src/drug/openai.service.ts</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../../prettify.css" />
    <link rel="stylesheet" href="../../base.css" />
    <link rel="shortcut icon" type="image/x-icon" href="../../favicon.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../../sort-arrow-sprite.png);
        }
    </style>
</head>
    
<body>
<div class='wrapper'>
    <div class='pad1'>
        <h1><a href="../../index.html">All files</a> / <a href="index.html">src/drug</a> openai.service.ts</h1>
        <div class='clearfix'>
            
            <div class='fl pad1y space-right2'>
                <span class="strong">6.6% </span>
                <span class="quiet">Statements</span>
                <span class='fraction'>7/106</span>
            </div>
        
            
            <div class='fl pad1y space-right2'>
                <span class="strong">11.76% </span>
                <span class="quiet">Branches</span>
                <span class='fraction'>6/51</span>
            </div>
        
            
            <div class='fl pad1y space-right2'>
                <span class="strong">0% </span>
                <span class="quiet">Functions</span>
                <span class='fraction'>0/18</span>
            </div>
        
            
            <div class='fl pad1y space-right2'>
                <span class="strong">4.9% </span>
                <span class="quiet">Lines</span>
                <span class='fraction'>5/102</span>
            </div>
        
            
        </div>
        <p class="quiet">
            Press <em>n</em> or <em>j</em> to go to the next uncovered block, <em>b</em>, <em>p</em> or <em>k</em> for the previous block.
        </p>
        <template id="filterTemplate">
            <div class="quiet">
                Filter:
                <input type="search" id="fileSearch">
            </div>
        </template>
    </div>
    <div class='status-line low'></div>
    <pre><table class="coverage">
<tr><td class="line-count quiet"><a name='L1'></a><a href='#L1'>1</a>
<a name='L2'></a><a href='#L2'>2</a>
<a name='L3'></a><a href='#L3'>3</a>
<a name='L4'></a><a href='#L4'>4</a>
<a name='L5'></a><a href='#L5'>5</a>
<a name='L6'></a><a href='#L6'>6</a>
<a name='L7'></a><a href='#L7'>7</a>
<a name='L8'></a><a href='#L8'>8</a>
<a name='L9'></a><a href='#L9'>9</a>
<a name='L10'></a><a href='#L10'>10</a>
<a name='L11'></a><a href='#L11'>11</a>
<a name='L12'></a><a href='#L12'>12</a>
<a name='L13'></a><a href='#L13'>13</a>
<a name='L14'></a><a href='#L14'>14</a>
<a name='L15'></a><a href='#L15'>15</a>
<a name='L16'></a><a href='#L16'>16</a>
<a name='L17'></a><a href='#L17'>17</a>
<a name='L18'></a><a href='#L18'>18</a>
<a name='L19'></a><a href='#L19'>19</a>
<a name='L20'></a><a href='#L20'>20</a>
<a name='L21'></a><a href='#L21'>21</a>
<a name='L22'></a><a href='#L22'>22</a>
<a name='L23'></a><a href='#L23'>23</a>
<a name='L24'></a><a href='#L24'>24</a>
<a name='L25'></a><a href='#L25'>25</a>
<a name='L26'></a><a href='#L26'>26</a>
<a name='L27'></a><a href='#L27'>27</a>
<a name='L28'></a><a href='#L28'>28</a>
<a name='L29'></a><a href='#L29'>29</a>
<a name='L30'></a><a href='#L30'>30</a>
<a name='L31'></a><a href='#L31'>31</a>
<a name='L32'></a><a href='#L32'>32</a>
<a name='L33'></a><a href='#L33'>33</a>
<a name='L34'></a><a href='#L34'>34</a>
<a name='L35'></a><a href='#L35'>35</a>
<a name='L36'></a><a href='#L36'>36</a>
<a name='L37'></a><a href='#L37'>37</a>
<a name='L38'></a><a href='#L38'>38</a>
<a name='L39'></a><a href='#L39'>39</a>
<a name='L40'></a><a href='#L40'>40</a>
<a name='L41'></a><a href='#L41'>41</a>
<a name='L42'></a><a href='#L42'>42</a>
<a name='L43'></a><a href='#L43'>43</a>
<a name='L44'></a><a href='#L44'>44</a>
<a name='L45'></a><a href='#L45'>45</a>
<a name='L46'></a><a href='#L46'>46</a>
<a name='L47'></a><a href='#L47'>47</a>
<a name='L48'></a><a href='#L48'>48</a>
<a name='L49'></a><a href='#L49'>49</a>
<a name='L50'></a><a href='#L50'>50</a>
<a name='L51'></a><a href='#L51'>51</a>
<a name='L52'></a><a href='#L52'>52</a>
<a name='L53'></a><a href='#L53'>53</a>
<a name='L54'></a><a href='#L54'>54</a>
<a name='L55'></a><a href='#L55'>55</a>
<a name='L56'></a><a href='#L56'>56</a>
<a name='L57'></a><a href='#L57'>57</a>
<a name='L58'></a><a href='#L58'>58</a>
<a name='L59'></a><a href='#L59'>59</a>
<a name='L60'></a><a href='#L60'>60</a>
<a name='L61'></a><a href='#L61'>61</a>
<a name='L62'></a><a href='#L62'>62</a>
<a name='L63'></a><a href='#L63'>63</a>
<a name='L64'></a><a href='#L64'>64</a>
<a name='L65'></a><a href='#L65'>65</a>
<a name='L66'></a><a href='#L66'>66</a>
<a name='L67'></a><a href='#L67'>67</a>
<a name='L68'></a><a href='#L68'>68</a>
<a name='L69'></a><a href='#L69'>69</a>
<a name='L70'></a><a href='#L70'>70</a>
<a name='L71'></a><a href='#L71'>71</a>
<a name='L72'></a><a href='#L72'>72</a>
<a name='L73'></a><a href='#L73'>73</a>
<a name='L74'></a><a href='#L74'>74</a>
<a name='L75'></a><a href='#L75'>75</a>
<a name='L76'></a><a href='#L76'>76</a>
<a name='L77'></a><a href='#L77'>77</a>
<a name='L78'></a><a href='#L78'>78</a>
<a name='L79'></a><a href='#L79'>79</a>
<a name='L80'></a><a href='#L80'>80</a>
<a name='L81'></a><a href='#L81'>81</a>
<a name='L82'></a><a href='#L82'>82</a>
<a name='L83'></a><a href='#L83'>83</a>
<a name='L84'></a><a href='#L84'>84</a>
<a name='L85'></a><a href='#L85'>85</a>
<a name='L86'></a><a href='#L86'>86</a>
<a name='L87'></a><a href='#L87'>87</a>
<a name='L88'></a><a href='#L88'>88</a>
<a name='L89'></a><a href='#L89'>89</a>
<a name='L90'></a><a href='#L90'>90</a>
<a name='L91'></a><a href='#L91'>91</a>
<a name='L92'></a><a href='#L92'>92</a>
<a name='L93'></a><a href='#L93'>93</a>
<a name='L94'></a><a href='#L94'>94</a>
<a name='L95'></a><a href='#L95'>95</a>
<a name='L96'></a><a href='#L96'>96</a>
<a name='L97'></a><a href='#L97'>97</a>
<a name='L98'></a><a href='#L98'>98</a>
<a name='L99'></a><a href='#L99'>99</a>
<a name='L100'></a><a href='#L100'>100</a>
<a name='L101'></a><a href='#L101'>101</a>
<a name='L102'></a><a href='#L102'>102</a>
<a name='L103'></a><a href='#L103'>103</a>
<a name='L104'></a><a href='#L104'>104</a>
<a name='L105'></a><a href='#L105'>105</a>
<a name='L106'></a><a href='#L106'>106</a>
<a name='L107'></a><a href='#L107'>107</a>
<a name='L108'></a><a href='#L108'>108</a>
<a name='L109'></a><a href='#L109'>109</a>
<a name='L110'></a><a href='#L110'>110</a>
<a name='L111'></a><a href='#L111'>111</a>
<a name='L112'></a><a href='#L112'>112</a>
<a name='L113'></a><a href='#L113'>113</a>
<a name='L114'></a><a href='#L114'>114</a>
<a name='L115'></a><a href='#L115'>115</a>
<a name='L116'></a><a href='#L116'>116</a>
<a name='L117'></a><a href='#L117'>117</a>
<a name='L118'></a><a href='#L118'>118</a>
<a name='L119'></a><a href='#L119'>119</a>
<a name='L120'></a><a href='#L120'>120</a>
<a name='L121'></a><a href='#L121'>121</a>
<a name='L122'></a><a href='#L122'>122</a>
<a name='L123'></a><a href='#L123'>123</a>
<a name='L124'></a><a href='#L124'>124</a>
<a name='L125'></a><a href='#L125'>125</a>
<a name='L126'></a><a href='#L126'>126</a>
<a name='L127'></a><a href='#L127'>127</a>
<a name='L128'></a><a href='#L128'>128</a>
<a name='L129'></a><a href='#L129'>129</a>
<a name='L130'></a><a href='#L130'>130</a>
<a name='L131'></a><a href='#L131'>131</a>
<a name='L132'></a><a href='#L132'>132</a>
<a name='L133'></a><a href='#L133'>133</a>
<a name='L134'></a><a href='#L134'>134</a>
<a name='L135'></a><a href='#L135'>135</a>
<a name='L136'></a><a href='#L136'>136</a>
<a name='L137'></a><a href='#L137'>137</a>
<a name='L138'></a><a href='#L138'>138</a>
<a name='L139'></a><a href='#L139'>139</a>
<a name='L140'></a><a href='#L140'>140</a>
<a name='L141'></a><a href='#L141'>141</a>
<a name='L142'></a><a href='#L142'>142</a>
<a name='L143'></a><a href='#L143'>143</a>
<a name='L144'></a><a href='#L144'>144</a>
<a name='L145'></a><a href='#L145'>145</a>
<a name='L146'></a><a href='#L146'>146</a>
<a name='L147'></a><a href='#L147'>147</a>
<a name='L148'></a><a href='#L148'>148</a>
<a name='L149'></a><a href='#L149'>149</a>
<a name='L150'></a><a href='#L150'>150</a>
<a name='L151'></a><a href='#L151'>151</a>
<a name='L152'></a><a href='#L152'>152</a>
<a name='L153'></a><a href='#L153'>153</a>
<a name='L154'></a><a href='#L154'>154</a>
<a name='L155'></a><a href='#L155'>155</a>
<a name='L156'></a><a href='#L156'>156</a>
<a name='L157'></a><a href='#L157'>157</a>
<a name='L158'></a><a href='#L158'>158</a>
<a name='L159'></a><a href='#L159'>159</a>
<a name='L160'></a><a href='#L160'>160</a>
<a name='L161'></a><a href='#L161'>161</a>
<a name='L162'></a><a href='#L162'>162</a>
<a name='L163'></a><a href='#L163'>163</a>
<a name='L164'></a><a href='#L164'>164</a>
<a name='L165'></a><a href='#L165'>165</a>
<a name='L166'></a><a href='#L166'>166</a>
<a name='L167'></a><a href='#L167'>167</a>
<a name='L168'></a><a href='#L168'>168</a>
<a name='L169'></a><a href='#L169'>169</a>
<a name='L170'></a><a href='#L170'>170</a>
<a name='L171'></a><a href='#L171'>171</a>
<a name='L172'></a><a href='#L172'>172</a>
<a name='L173'></a><a href='#L173'>173</a>
<a name='L174'></a><a href='#L174'>174</a>
<a name='L175'></a><a href='#L175'>175</a>
<a name='L176'></a><a href='#L176'>176</a>
<a name='L177'></a><a href='#L177'>177</a>
<a name='L178'></a><a href='#L178'>178</a>
<a name='L179'></a><a href='#L179'>179</a>
<a name='L180'></a><a href='#L180'>180</a>
<a name='L181'></a><a href='#L181'>181</a>
<a name='L182'></a><a href='#L182'>182</a>
<a name='L183'></a><a href='#L183'>183</a>
<a name='L184'></a><a href='#L184'>184</a>
<a name='L185'></a><a href='#L185'>185</a>
<a name='L186'></a><a href='#L186'>186</a>
<a name='L187'></a><a href='#L187'>187</a>
<a name='L188'></a><a href='#L188'>188</a>
<a name='L189'></a><a href='#L189'>189</a>
<a name='L190'></a><a href='#L190'>190</a>
<a name='L191'></a><a href='#L191'>191</a>
<a name='L192'></a><a href='#L192'>192</a>
<a name='L193'></a><a href='#L193'>193</a>
<a name='L194'></a><a href='#L194'>194</a>
<a name='L195'></a><a href='#L195'>195</a>
<a name='L196'></a><a href='#L196'>196</a>
<a name='L197'></a><a href='#L197'>197</a>
<a name='L198'></a><a href='#L198'>198</a>
<a name='L199'></a><a href='#L199'>199</a>
<a name='L200'></a><a href='#L200'>200</a>
<a name='L201'></a><a href='#L201'>201</a>
<a name='L202'></a><a href='#L202'>202</a>
<a name='L203'></a><a href='#L203'>203</a>
<a name='L204'></a><a href='#L204'>204</a>
<a name='L205'></a><a href='#L205'>205</a>
<a name='L206'></a><a href='#L206'>206</a>
<a name='L207'></a><a href='#L207'>207</a>
<a name='L208'></a><a href='#L208'>208</a>
<a name='L209'></a><a href='#L209'>209</a>
<a name='L210'></a><a href='#L210'>210</a>
<a name='L211'></a><a href='#L211'>211</a>
<a name='L212'></a><a href='#L212'>212</a>
<a name='L213'></a><a href='#L213'>213</a>
<a name='L214'></a><a href='#L214'>214</a>
<a name='L215'></a><a href='#L215'>215</a>
<a name='L216'></a><a href='#L216'>216</a>
<a name='L217'></a><a href='#L217'>217</a>
<a name='L218'></a><a href='#L218'>218</a>
<a name='L219'></a><a href='#L219'>219</a>
<a name='L220'></a><a href='#L220'>220</a>
<a name='L221'></a><a href='#L221'>221</a>
<a name='L222'></a><a href='#L222'>222</a>
<a name='L223'></a><a href='#L223'>223</a>
<a name='L224'></a><a href='#L224'>224</a>
<a name='L225'></a><a href='#L225'>225</a>
<a name='L226'></a><a href='#L226'>226</a>
<a name='L227'></a><a href='#L227'>227</a>
<a name='L228'></a><a href='#L228'>228</a>
<a name='L229'></a><a href='#L229'>229</a>
<a name='L230'></a><a href='#L230'>230</a>
<a name='L231'></a><a href='#L231'>231</a>
<a name='L232'></a><a href='#L232'>232</a>
<a name='L233'></a><a href='#L233'>233</a>
<a name='L234'></a><a href='#L234'>234</a>
<a name='L235'></a><a href='#L235'>235</a>
<a name='L236'></a><a href='#L236'>236</a>
<a name='L237'></a><a href='#L237'>237</a>
<a name='L238'></a><a href='#L238'>238</a>
<a name='L239'></a><a href='#L239'>239</a>
<a name='L240'></a><a href='#L240'>240</a>
<a name='L241'></a><a href='#L241'>241</a>
<a name='L242'></a><a href='#L242'>242</a>
<a name='L243'></a><a href='#L243'>243</a>
<a name='L244'></a><a href='#L244'>244</a>
<a name='L245'></a><a href='#L245'>245</a>
<a name='L246'></a><a href='#L246'>246</a>
<a name='L247'></a><a href='#L247'>247</a>
<a name='L248'></a><a href='#L248'>248</a>
<a name='L249'></a><a href='#L249'>249</a>
<a name='L250'></a><a href='#L250'>250</a>
<a name='L251'></a><a href='#L251'>251</a>
<a name='L252'></a><a href='#L252'>252</a>
<a name='L253'></a><a href='#L253'>253</a>
<a name='L254'></a><a href='#L254'>254</a>
<a name='L255'></a><a href='#L255'>255</a>
<a name='L256'></a><a href='#L256'>256</a>
<a name='L257'></a><a href='#L257'>257</a>
<a name='L258'></a><a href='#L258'>258</a>
<a name='L259'></a><a href='#L259'>259</a>
<a name='L260'></a><a href='#L260'>260</a>
<a name='L261'></a><a href='#L261'>261</a>
<a name='L262'></a><a href='#L262'>262</a>
<a name='L263'></a><a href='#L263'>263</a>
<a name='L264'></a><a href='#L264'>264</a>
<a name='L265'></a><a href='#L265'>265</a>
<a name='L266'></a><a href='#L266'>266</a>
<a name='L267'></a><a href='#L267'>267</a>
<a name='L268'></a><a href='#L268'>268</a>
<a name='L269'></a><a href='#L269'>269</a>
<a name='L270'></a><a href='#L270'>270</a>
<a name='L271'></a><a href='#L271'>271</a>
<a name='L272'></a><a href='#L272'>272</a>
<a name='L273'></a><a href='#L273'>273</a>
<a name='L274'></a><a href='#L274'>274</a>
<a name='L275'></a><a href='#L275'>275</a>
<a name='L276'></a><a href='#L276'>276</a>
<a name='L277'></a><a href='#L277'>277</a>
<a name='L278'></a><a href='#L278'>278</a>
<a name='L279'></a><a href='#L279'>279</a>
<a name='L280'></a><a href='#L280'>280</a>
<a name='L281'></a><a href='#L281'>281</a>
<a name='L282'></a><a href='#L282'>282</a>
<a name='L283'></a><a href='#L283'>283</a>
<a name='L284'></a><a href='#L284'>284</a>
<a name='L285'></a><a href='#L285'>285</a>
<a name='L286'></a><a href='#L286'>286</a>
<a name='L287'></a><a href='#L287'>287</a>
<a name='L288'></a><a href='#L288'>288</a>
<a name='L289'></a><a href='#L289'>289</a>
<a name='L290'></a><a href='#L290'>290</a>
<a name='L291'></a><a href='#L291'>291</a>
<a name='L292'></a><a href='#L292'>292</a>
<a name='L293'></a><a href='#L293'>293</a>
<a name='L294'></a><a href='#L294'>294</a>
<a name='L295'></a><a href='#L295'>295</a>
<a name='L296'></a><a href='#L296'>296</a>
<a name='L297'></a><a href='#L297'>297</a>
<a name='L298'></a><a href='#L298'>298</a>
<a name='L299'></a><a href='#L299'>299</a>
<a name='L300'></a><a href='#L300'>300</a>
<a name='L301'></a><a href='#L301'>301</a>
<a name='L302'></a><a href='#L302'>302</a>
<a name='L303'></a><a href='#L303'>303</a>
<a name='L304'></a><a href='#L304'>304</a>
<a name='L305'></a><a href='#L305'>305</a>
<a name='L306'></a><a href='#L306'>306</a>
<a name='L307'></a><a href='#L307'>307</a>
<a name='L308'></a><a href='#L308'>308</a>
<a name='L309'></a><a href='#L309'>309</a>
<a name='L310'></a><a href='#L310'>310</a>
<a name='L311'></a><a href='#L311'>311</a>
<a name='L312'></a><a href='#L312'>312</a>
<a name='L313'></a><a href='#L313'>313</a>
<a name='L314'></a><a href='#L314'>314</a>
<a name='L315'></a><a href='#L315'>315</a>
<a name='L316'></a><a href='#L316'>316</a>
<a name='L317'></a><a href='#L317'>317</a>
<a name='L318'></a><a href='#L318'>318</a>
<a name='L319'></a><a href='#L319'>319</a>
<a name='L320'></a><a href='#L320'>320</a>
<a name='L321'></a><a href='#L321'>321</a></td><td class="line-coverage quiet"><span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">4x</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">import { Injectable, Logger } from '@nestjs/common';
import { ConfigService } from '@nestjs/config';
import OpenAI from 'openai';
import { DrugLabel } from './interfaces/drug-label.interface';
import { CacheService } from './cache.service';
&nbsp;
@Injectable()
export class OpenAIService {
  private readonly logger = <span class="cstat-no" title="statement not covered" >new Logger(OpenAIService.name);</span>
  private openai: OpenAI;
  private readonly maxRetries = <span class="cstat-no" title="statement not covered" >3;</span>
  private readonly baseDelay = <span class="cstat-no" title="statement not covered" >1000;</span> // 1 second
&nbsp;
<span class="fstat-no" title="function not covered" >  constructor(</span>
    private <span class="cstat-no" title="statement not covered" >configService: C</span>onfigService<span class="branch-1 cbranch-no" title="branch not covered" >,</span>
    private readonly <span class="cstat-no" title="statement not covered" >cacheService: C</span>acheService<span class="branch-1 cbranch-no" title="branch not covered" ></span>
  ) {
    const apiKey = <span class="cstat-no" title="statement not covered" >this.configService.get&lt;string&gt;('OPENAI_API_KEY');</span>
<span class="cstat-no" title="statement not covered" >    if (!apiKey) {</span>
<span class="cstat-no" title="statement not covered" >      this.logger.warn('OpenAI API key not found. AI features will be disabled.');</span>
<span class="cstat-no" title="statement not covered" >      return;</span>
    }
    
<span class="cstat-no" title="statement not covered" >    this.openai = new OpenAI({</span>
      apiKey,
    });
  }
&nbsp;
<span class="fstat-no" title="function not covered" >  async </span>generateSEOMetadata(drug: DrugLabel): Promise&lt;{ title: string; description: string }&gt; {
<span class="cstat-no" title="statement not covered" >    if (!this.openai) {</span>
<span class="cstat-no" title="statement not covered" >      return this.getFallbackSEOMetadata(drug);</span>
    }
&nbsp;
    // Check cache first
    const cacheKey = <span class="cstat-no" title="statement not covered" >`seo_metadata:${drug.setId}`;</span>
    const cached = <span class="cstat-no" title="statement not covered" >await this.cacheService.get&lt;{ title: string; description: string }&gt;(cacheKey);</span>
<span class="cstat-no" title="statement not covered" >    if (cached) {</span>
<span class="cstat-no" title="statement not covered" >      return cached;</span>
    }
&nbsp;
    const prompt = <span class="cstat-no" title="statement not covered" >`Generate SEO-optimized title and meta description for the prescription drug ${drug.drugName} (generic name: ${drug.label.genericName}) manufactured by ${drug.labeler}. Key information: - Drug Name: ${drug.drugName} - Generic Name: ${drug.label.genericName} - Labeler: ${drug.labeler} - Product Type: ${drug.label.productType} ${drug.label.indicationsAndUsage ? `- Primary Uses: ${this.stripHtml(drug.label.indicationsAndUsage).substring(0, 200)}...` : ''} Return JSON with "title" (max 60 chars) and "description" (max 160 chars). Make them engaging and informative for patients and healthcare providers searching for drug information.`;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    return await this.callOpenAIWithRetry(<span class="fstat-no" title="function not covered" >async </span>() =&gt; {</span>
      const completion = <span class="cstat-no" title="statement not covered" >await this.openai.chat.completions.create({</span>
        model: 'gpt-3.5-turbo',
        messages: [{ role: 'user', content: prompt }],
        temperature: 0.7,
        max_tokens: 200,
      });
&nbsp;
      const response = <span class="cstat-no" title="statement not covered" >completion.choices[0]?.message?.content;</span>
<span class="cstat-no" title="statement not covered" >      if (!response) {</span>
<span class="cstat-no" title="statement not covered" >        throw new Error('No response from OpenAI');</span>
      }
&nbsp;
<span class="cstat-no" title="statement not covered" >      try {</span>
        const result = <span class="cstat-no" title="statement not covered" >JSON.parse(response);</span>
        // Cache the result
<span class="cstat-no" title="statement not covered" >        await this.cacheService.set(cacheKey, result, 86400); </span>// 24 hour TTL
<span class="cstat-no" title="statement not covered" >        return result;</span>
      } catch (error) {
<span class="cstat-no" title="statement not covered" >        this.logger.warn('Failed to parse OpenAI response, using fallback');</span>
<span class="cstat-no" title="statement not covered" >        return this.getFallbackSEOMetadata(drug);</span>
      }
    }, drug);
  }
&nbsp;
<span class="fstat-no" title="function not covered" >  async </span>generateDrugSummary(drug: DrugLabel): Promise&lt;string&gt; {
<span class="cstat-no" title="statement not covered" >    if (!this.openai) {</span>
<span class="cstat-no" title="statement not covered" >      return this.getFallbackSummary(drug);</span>
    }
&nbsp;
    // Check cache first
    const cacheKey = <span class="cstat-no" title="statement not covered" >`drug_summary:${drug.setId}`;</span>
    const cached = <span class="cstat-no" title="statement not covered" >await this.cacheService.get&lt;string&gt;(cacheKey);</span>
<span class="cstat-no" title="statement not covered" >    if (cached) {</span>
<span class="cstat-no" title="statement not covered" >      return cached;</span>
    }
&nbsp;
    const prompt = <span class="cstat-no" title="statement not covered" >`Create a clear, informative summary for the prescription medication ${drug.drugName} (${drug.label.genericName}). Key details: - Brand Name: ${drug.drugName} - Generic Name: ${drug.label.genericName} - Manufacturer: ${drug.labeler} ${drug.label.indicationsAndUsage ? `- Primary Uses: ${this.stripHtml(drug.label.indicationsAndUsage).substring(0, 300)}...` : ''} Write 2-3 sentences that explain what this medication is, what it treats, and who makes it. Keep it professional but accessible to patients. Do not include dosage information or medical advice.`;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    return await this.callOpenAIWithRetry(<span class="fstat-no" title="function not covered" >async </span>() =&gt; {</span>
      const completion = <span class="cstat-no" title="statement not covered" >await this.openai.chat.completions.create({</span>
        model: 'gpt-3.5-turbo',
        messages: [{ role: 'user', content: prompt }],
        temperature: 0.6,
        max_tokens: 150,
      });
&nbsp;
      const response = <span class="cstat-no" title="statement not covered" >completion.choices[0]?.message?.content?.trim();</span>
      const summary = <span class="cstat-no" title="statement not covered" >response || this.getFallbackSummary(drug);</span>
      
      // Cache the result
<span class="cstat-no" title="statement not covered" >      await this.cacheService.set(cacheKey, summary, 86400); </span>// 24 hour TTL
<span class="cstat-no" title="statement not covered" >      return summary;</span>
    }, drug);
  }
&nbsp;
<span class="fstat-no" title="function not covered" >  async </span>enhanceAllSections(drug: DrugLabel): Promise&lt;Partial&lt;DrugLabel['label']&gt;&gt; {
<span class="cstat-no" title="statement not covered" >    if (!this.openai) {</span>
<span class="cstat-no" title="statement not covered" >      return {};</span>
    }
&nbsp;
    // Check cache first
    const cacheKey = <span class="cstat-no" title="statement not covered" >`enhanced_sections:${drug.setId}`;</span>
    const cached = <span class="cstat-no" title="statement not covered" >await this.cacheService.get&lt;Partial&lt;DrugLabel['label']&gt;&gt;(cacheKey);</span>
<span class="cstat-no" title="statement not covered" >    if (cached) {</span>
<span class="cstat-no" title="statement not covered" >      return cached;</span>
    }
&nbsp;
    const sectionsToEnhance = <span class="cstat-no" title="statement not covered" >{</span>
      indicationsAndUsage: drug.label.indicationsAndUsage,
      dosageAndAdministration: drug.label.dosageAndAdministration,
      dosageFormsAndStrengths: drug.label.dosageFormsAndStrengths,
      warningsAndPrecautions: drug.label.warningsAndPrecautions,
      adverseReactions: drug.label.adverseReactions,
      clinicalPharmacology: drug.label.clinicalPharmacology,
      clinicalStudies: drug.label.clinicalStudies,
      howSupplied: drug.label.howSupplied,
      useInSpecificPopulations: drug.label.useInSpecificPopulations,
      description: drug.label.description,
      nonclinicalToxicology: drug.label.nonclinicalToxicology,
      instructionsForUse: drug.label.instructionsForUse
    };
&nbsp;
    // Filter out undefined sections
    const availableSections = <span class="cstat-no" title="statement not covered" >Object.entries(sectionsToEnhance)</span>
      .filter(<span class="fstat-no" title="function not covered" >([</span>_, content]) =&gt; <span class="cstat-no" title="statement not covered" >content &amp;&amp; content.trim())</span>
      .reduce(<span class="fstat-no" title="function not covered" >(a</span>cc, [key, content]) =&gt; (<span class="cstat-no" title="statement not covered" >{</span>
        ...acc,
        [key]: this.stripHtml(content as string).substring(0, 1000)
      }), {});
&nbsp;
<span class="cstat-no" title="statement not covered" >    if (Object.keys(availableSections).length === 0) {</span>
<span class="cstat-no" title="statement not covered" >      return {};</span>
    }
&nbsp;
    const systemPrompt = <span class="cstat-no" title="statement not covered" >`You are a medical communication specialist. Your task is to enhance drug label sections to make them more accessible and patient-friendly while maintaining complete medical accuracy. For each provided section, rewrite the content to be clearer and more understandable to patients, but keep all essential medical information. Use simple language and explain medical terms when necessary.`;</span>
&nbsp;
    const userPrompt = <span class="cstat-no" title="statement not covered" >`Please enhance the following sections for the prescription drug ${drug.drugName} (${drug.label.genericName}) by ${drug.labeler}. Make each section more patient-friendly while maintaining medical accuracy: ${JSON.stringify(availableSections)}`;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    return await this.callOpenAIWithRetry(<span class="fstat-no" title="function not covered" >async </span>() =&gt; {</span>
      const response = <span class="cstat-no" title="statement not covered" >await this.openai.responses.create({</span>
        model: "gpt-4o-2024-08-06",
        temperature: 0.5,
        input: [
          { role: "system", content: systemPrompt },
          { role: "user", content: userPrompt }
        ],
        text: {
          format: {
            type: "json_schema",
            name: "drug_summary",
            schema: {
              type: "object",
              properties: {
                indicationsAndUsage: {
                  type: "string",
                  description: "Enhance the indications and usage section to be more accessible to patients. Explain what conditions this medication treats and why doctors prescribe it. Use simple language to describe the therapeutic uses while maintaining medical accuracy."
                },
                dosageAndAdministration: {
                  type: "string", 
                  description: "Rewrite the dosage and administration information to be more patient-friendly. Explain how the medication should be taken, when to take it, and any important administration instructions. Clarify medical terms and provide context for dosing schedules."
                },
                dosageFormsAndStrengths: {
                  type: "string",
                  description: "Simplify the dosage forms and strengths section for patient understanding. Explain what forms the medication comes in (tablets, capsules, liquid, etc.) and what the different strengths mean in practical terms."
                },
                warningsAndPrecautions: {
                  type: "string",
                  description: "Enhance the warnings and precautions section to be more understandable while maintaining urgency. Explain potential risks, when to contact a doctor, and important safety information in clear, accessible language."
                },
                adverseReactions: {
                  type: "string",
                  description: "Rewrite the adverse reactions section to be more patient-friendly. Explain what side effects patients might experience, categorize them by severity or frequency when possible, and clarify medical terminology."
                },
                clinicalPharmacology: {
                  type: "string",
                  description: "Simplify the clinical pharmacology section for patient comprehension. Explain how the medication works in the body, its mechanism of action, and absorption/elimination in understandable terms."
                },
                clinicalStudies: {
                  type: "string",
                  description: "Enhance the clinical studies section to be more accessible. Explain what research has been done to test the medication's effectiveness, what the studies showed, and what this means for patients in simple terms."
                },
                howSupplied: {
                  type: "string",
                  description: "Rewrite the how supplied section to be more patient-friendly. Explain how the medication is packaged, what patients can expect when they receive their prescription, and any storage instructions in clear language."
                },
                useInSpecificPopulations: {
                  type: "string", 
                  description: "Simplify the use in specific populations section for better understanding. Explain how the medication affects different groups (pregnant women, elderly, children, etc.) and any special considerations in accessible language."
                },
                description: {
                  type: "string",
                  description: "Enhance the description section to be more patient-friendly. Explain what the medication contains, its chemical properties, and physical characteristics in understandable terms while maintaining accuracy."
                },
                nonclinicalToxicology: {
                  type: "string",
                  description: "Rewrite the nonclinical toxicology section to be more accessible. Explain what safety testing has been done in laboratory studies and what this means for patient safety in simple, clear language."
                },
                instructionsForUse: {
                  type: "string",
                  description: "Enhance the instructions for use section to be more patient-friendly. Provide clear, step-by-step guidance on how to properly use the medication, explaining any special devices or techniques required."
                }
              },
              required: Object.keys(availableSections),
              additionalProperties: false
            }
          }
        }
      });
&nbsp;
      const result = <span class="cstat-no" title="statement not covered" >JSON.parse(response.output_text);</span>
      
      // Cache the result
<span class="cstat-no" title="statement not covered" >      await this.cacheService.set(cacheKey, result, 86400); </span>// 24 hour TTL
<span class="cstat-no" title="statement not covered" >      return result;</span>
    }, drug);
  }
&nbsp;
  // Legacy method - now deprecated in favor of enhanceAllSections
<span class="fstat-no" title="function not covered" >  async </span>enhanceSection(content: string, drug: DrugLabel): Promise&lt;string&gt; {
<span class="cstat-no" title="statement not covered" >    this.logger.warn('enhanceSection is deprecated. Use enhanceAllSections for better efficiency.');</span>
<span class="cstat-no" title="statement not covered" >    if (!this.openai || !content) {</span>
<span class="cstat-no" title="statement not covered" >      return '';</span>
    }
&nbsp;
    // Check cache first
    const cacheKey = <span class="cstat-no" title="statement not covered" >`enhanced_section:${drug.setId}:${this.hashContent(content)}`;</span>
    const cached = <span class="cstat-no" title="statement not covered" >await this.cacheService.get&lt;string&gt;(cacheKey);</span>
<span class="cstat-no" title="statement not covered" >    if (cached) {</span>
<span class="cstat-no" title="statement not covered" >      return cached;</span>
    }
&nbsp;
    const strippedContent = <span class="cstat-no" title="statement not covered" >this.stripHtml(content).substring(0, 1000);</span>
    const prompt = <span class="cstat-no" title="statement not covered" >`Improve the readability of this drug information section for ${drug.drugName}. Make it more accessible to patients while keeping all medical accuracy. Add helpful context where appropriate. Original content: ${strippedContent} Rewrite this to be clearer and more patient-friendly while maintaining medical accuracy. Use simple language and explain medical terms. Keep the same essential information.`;</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >    return await this.callOpenAIWithRetry(<span class="fstat-no" title="function not covered" >async </span>() =&gt; {</span>
      const completion = <span class="cstat-no" title="statement not covered" >await this.openai.chat.completions.create({</span>
        model: 'gpt-3.5-turbo',
        messages: [{ role: 'user', content: prompt }],
        temperature: 0.5,
        max_tokens: 500,
      });
&nbsp;
      const response = <span class="cstat-no" title="statement not covered" >completion.choices[0]?.message?.content?.trim() || '';</span>
      
      // Cache the result
<span class="cstat-no" title="statement not covered" >      if (response) {</span>
<span class="cstat-no" title="statement not covered" >        await this.cacheService.set(cacheKey, response, 86400); </span>// 24 hour TTL
      }
<span class="cstat-no" title="statement not covered" >      return response;</span>
    }, drug);
  }
&nbsp;
  private <span class="fstat-no" title="function not covered" >async </span>callOpenAIWithRetry&lt;T&gt;(
    operation: () =&gt; Promise&lt;T&gt;,
    drug: DrugLabel,
    attempt: number = <span class="branch-0 cbranch-no" title="branch not covered" >1</span>
  ): Promise&lt;T&gt; {
<span class="cstat-no" title="statement not covered" >    try {</span>
<span class="cstat-no" title="statement not covered" >      return await operation();</span>
    } catch (error: any) {
<span class="cstat-no" title="statement not covered" >      this.logger.warn(`OpenAI API call failed for ${drug.drugName} (attempt ${attempt}):`, error.message);</span>
&nbsp;
<span class="cstat-no" title="statement not covered" >      if (attempt &gt;= this.maxRetries) {</span>
<span class="cstat-no" title="statement not covered" >        this.logger.error(`Max retries exceeded for ${drug.drugName}`);</span>
<span class="cstat-no" title="statement not covered" >        throw error;</span>
      }
&nbsp;
      // Handle rate limits with exponential backoff
<span class="cstat-no" title="statement not covered" >      if (error.status === 429 || error.code === 'rate_limit_exceeded') {</span>
        const delay = <span class="cstat-no" title="statement not covered" >this.baseDelay * Math.pow(2, attempt - 1);</span>
<span class="cstat-no" title="statement not covered" >        this.logger.log(`Rate limited, waiting ${delay}ms before retry ${attempt + 1}`);</span>
<span class="cstat-no" title="statement not covered" >        await this.sleep(delay);</span>
      } else {
        // For other errors, shorter delay
<span class="cstat-no" title="statement not covered" >        await this.sleep(500);</span>
      }
&nbsp;
<span class="cstat-no" title="statement not covered" >      return this.callOpenAIWithRetry(operation, drug, attempt + 1);</span>
    }
  }
&nbsp;
  private <span class="fstat-no" title="function not covered" >getFallbackSEOMetadata(</span>drug: DrugLabel): { title: string; description: string } {
<span class="cstat-no" title="statement not covered" >    return {</span>
      title: `${drug.drugName} (${drug.label.genericName}) - Prescription Info`,
      description: `Complete prescribing information for ${drug.drugName} (${drug.label.genericName}) by ${drug.labeler}. Dosage, side effects, warnings &amp; more.`,
    };
  }
&nbsp;
  private <span class="fstat-no" title="function not covered" >getFallbackSummary(</span>drug: DrugLabel): string {
<span class="cstat-no" title="statement not covered" >    return `${drug.drugName} is a prescription medication containing the active ingredient ${drug.label.genericName}, manufactured by ${drug.labeler}.`;</span>
  }
&nbsp;
  private <span class="fstat-no" title="function not covered" >stripHtml(</span>html: string): string {
<span class="cstat-no" title="statement not covered" >    return html</span>
      .replace(/&lt;[^&gt;]*&gt;/g, '')
      .replace(/&amp;nbsp;/g, ' ')
      .replace(/&amp;amp;/g, '&amp;')
      .replace(/&amp;lt;/g, '&lt;')
      .replace(/&amp;gt;/g, '&gt;')
      .replace(/\s+/g, ' ')
      .trim();
  }
&nbsp;
  private <span class="fstat-no" title="function not covered" >sleep(</span>ms: number): Promise&lt;void&gt; {
<span class="cstat-no" title="statement not covered" >    return new Promise(<span class="fstat-no" title="function not covered" >resolve </span>=&gt; <span class="cstat-no" title="statement not covered" >setTimeout(resolve, ms))</span>;</span>
  }
&nbsp;
  private <span class="fstat-no" title="function not covered" >hashContent(</span>content: string): string {
    // Simple hash for caching section content
    let hash = <span class="cstat-no" title="statement not covered" >0;</span>
<span class="cstat-no" title="statement not covered" >    for (let i = <span class="cstat-no" title="statement not covered" >0;</span> i &lt; content.length; i++) {</span>
      const char = <span class="cstat-no" title="statement not covered" >content.charCodeAt(i);</span>
<span class="cstat-no" title="statement not covered" >      hash = ((hash &lt;&lt; 5) - hash) + char;</span>
<span class="cstat-no" title="statement not covered" >      hash = hash &amp; hash; </span>// Convert to 32-bit integer
    }
<span class="cstat-no" title="statement not covered" >    return Math.abs(hash).toString(16);</span>
  }
}</pre></td></tr></table></pre>

                <div class='push'></div><!-- for sticky footer -->
            </div><!-- /wrapper -->
            <div class='footer quiet pad2 space-top1 center small'>
                Code coverage generated by
                <a href="https://istanbul.js.org/" target="_blank" rel="noopener noreferrer">istanbul</a>
                at 2025-09-04T02:07:31.794Z
            </div>
        <script src="../../prettify.js"></script>
        <script>
            window.onload = function () {
                prettyPrint();
            };
        </script>
        <script src="../../sorter.js"></script>
        <script src="../../block-navigation.js"></script>
    </body>
</html>
    